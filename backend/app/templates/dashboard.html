{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ - US Stock Trading Bot{% endblock %}

{% block content %}
<h1>ëŒ€ì‹œë³´ë“œ</h1>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if warning %}
<div class="alert alert-warning">{{ warning }}</div>
{% endif %}

<!-- AI íˆ¬ì ë¶„ì„ ì±—ë´‡ -->
<div class="card">
    <h2>ğŸ’¬ AI íˆ¬ì ë¶„ì„</h2>
    <div style="display: flex; flex-direction: column; gap: 1rem;">
        <!-- ì±—ë´‡ ëŒ€í™”ì°½ -->
        <div id="chatMessages" style="min-height: 300px; max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 1rem; background: #f8f9fa;">
            <div style="text-align: center; color: #666; padding: 2rem;">
                <p>ğŸ’¡ AI íˆ¬ì ë¶„ì„ ë„ìš°ë¯¸ì—ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”</p>
                <small>ì˜ˆì‹œ: "í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„í•´ì¤˜", "ì´ë²ˆ ì£¼ ì‹œì¥ ë™í–¥ì€?", "ì¶”ì²œ ì¢…ëª© ì•Œë ¤ì¤˜"</small>
            </div>
        </div>

        <!-- ì…ë ¥ì°½ -->
        <div style="display: flex; gap: 0.5rem;">
            <input type="text" id="chatInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;" onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" class="success" style="padding: 0.75rem 2rem;">ì „ì†¡</button>
        </div>
    </div>
</div>

<!-- í¬íŠ¸í´ë¦¬ì˜¤ ìš”ì•½ -->
<div class="grid">
    <div class="stat-card">
        <h3>ì´ ìì‚°</h3>
        <div class="value">â‚©{{ "{:,}".format(portfolio.total_value|int) }}</div>
    </div>
    <div class="stat-card">
        <h3>í˜„ê¸ˆ ì”ê³ </h3>
        <div class="value">â‚©{{ "{:,}".format(portfolio.cash_balance|int) }}</div>
    </div>
    <div class="stat-card">
        <h3>ì¼ì¼ ì†ìµ</h3>
        <div class="value {% if portfolio.daily_pnl_pct >= 0 %}positive{% else %}negative{% endif %}">
            {{ "+" if portfolio.daily_pnl_pct >= 0 else "" }}{{ "%.2f"|format(portfolio.daily_pnl_pct) }}%
        </div>
        <small>â‚©{{ "{:,}".format(portfolio.daily_pnl|int) }}</small>
    </div>
    <div class="stat-card">
        <h3>ì´ ì†ìµ</h3>
        <div class="value {% if portfolio.total_pnl_pct >= 0 %}positive{% else %}negative{% endif %}">
            {{ "+" if portfolio.total_pnl_pct >= 0 else "" }}{{ "%.2f"|format(portfolio.total_pnl_pct) }}%
        </div>
        <small>â‚©{{ "{:,}".format(portfolio.total_pnl|int) }}</small>
    </div>
</div>

<!-- ë³´ìœ  í¬ì§€ì…˜ -->
<div class="card">
    <h2>ë³´ìœ  í¬ì§€ì…˜ ({{ portfolio.position_count }}ê°œ)</h2>
    {% if portfolio.positions %}
    <table>
        <thead>
            <tr>
                <th>ì¢…ëª©</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>í‰ë‹¨ê°€</th>
                <th>í˜„ì¬ê°€</th>
                <th>í‰ê°€ì•¡</th>
                <th>ì†ìµë¥ </th>
            </tr>
        </thead>
        <tbody>
            {% for pos in portfolio.positions %}
            <tr>
                <td><strong>{{ pos.ticker }}</strong></td>
                <td>{{ pos.quantity }}ì£¼</td>
                <td>${{ "%.2f"|format(pos.avg_cost) }}</td>
                <td>${{ "%.2f"|format(pos.current_price) }}</td>
                <td>â‚©{{ "{:,}".format(pos.total_value|int) }}</td>
                <td class="{% if pos.unrealized_pnl_pct >= 0 %}positive{% else %}negative{% endif %}">
                    {{ "+" if pos.unrealized_pnl_pct >= 0 else "" }}{{ "%.2f"|format(pos.unrealized_pnl_pct) }}%
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #666;">ë³´ìœ  ì¤‘ì¸ í¬ì§€ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
    // ì±—ë´‡ ë©”ì‹œì§€ ì „ì†¡
    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const messagesDiv = document.getElementById('chatMessages');
        const message = input.value.trim();

        if (!message) return;

        // ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ ì œê±°
        if (messagesDiv.children.length === 1 && messagesDiv.children[0].style.textAlign === 'center') {
            messagesDiv.innerHTML = '';
        }

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        addMessage('user', message);
        input.value = '';

        // ë¡œë”© í‘œì‹œ
        const loadingId = 'loading-' + Date.now();
        addMessage('assistant', 'ë¶„ì„ ì¤‘...', loadingId);

        try {
            // API í˜¸ì¶œ
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: message})
            });

            const data = await response.json();

            // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            const loadingMsg = document.getElementById(loadingId);
            if (loadingMsg) loadingMsg.remove();

            // AI ì‘ë‹µ ì¶”ê°€
            if (data.response) {
                addMessage('assistant', data.response);
            } else {
                addMessage('assistant', 'âŒ ì˜¤ë¥˜: ' + (data.error || 'ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'));
            }
        } catch (error) {
            // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            const loadingMsg = document.getElementById(loadingId);
            if (loadingMsg) loadingMsg.remove();

            addMessage('assistant', 'âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error.message);
        }

        // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addMessage(role, content, id = null) {
        const messagesDiv = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        if (id) messageDiv.id = id;

        messageDiv.style.cssText = `
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            ${role === 'user'
                ? 'background: #007bff; color: white; margin-left: 20%; text-align: right;'
                : 'background: white; border: 1px solid #ddd; margin-right: 20%;'
            }
        `;

        messageDiv.innerHTML = `
            <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.25rem;">
                ${role === 'user' ? 'ğŸ‘¤ ë‚˜' : 'ğŸ¤– AI ë¶„ì„'}
            </div>
            <div style="white-space: pre-wrap; line-height: 1.5;">${content}</div>
        `;

        messagesDiv.appendChild(messageDiv);
    }

    // ì—”í„° í‚¤ë¡œ ì „ì†¡
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>
{% endblock %}
