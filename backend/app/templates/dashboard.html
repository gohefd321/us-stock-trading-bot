{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ - US Stock Trading Bot{% endblock %}

{% block content %}
<h1>ëŒ€ì‹œë³´ë“œ</h1>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if warning %}
<div class="alert alert-warning">{{ warning | safe }}</div>
{% endif %}

<!-- AI ë§¤ë§¤ ì¶”ì²œ -->
<div class="card">
    <h2>ğŸ¤– AI ë§¤ë§¤ ì¶”ì²œ</h2>
    <div id="recommendationsSection">
        <div style="text-align: center; color: #666; padding: 2rem;">
            <p>ë¡œë”© ì¤‘...</p>
        </div>
    </div>
    <button onclick="refreshRecommendations()" class="success" style="margin-top: 1rem;">ğŸ”„ ì¶”ì²œ ìƒˆë¡œê³ ì¹¨</button>
</div>

<!-- AI íˆ¬ì ë¶„ì„ ì±—ë´‡ -->
<div class="card">
    <h2>ğŸ’¬ AI íˆ¬ì ë¶„ì„</h2>
    <div style="display: flex; flex-direction: column; gap: 1rem;">
        <!-- ì±—ë´‡ ëŒ€í™”ì°½ -->
        <div id="chatMessages" style="min-height: 300px; max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 1rem; background: #f8f9fa;">
            <div style="text-align: center; color: #666; padding: 2rem;">
                <p>ğŸ’¡ AI íˆ¬ì ë¶„ì„ ë„ìš°ë¯¸ì—ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”</p>
                <small>ì˜ˆì‹œ: "í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„í•´ì¤˜", "ì´ë²ˆ ì£¼ ì‹œì¥ ë™í–¥ì€?", "ì¶”ì²œ ì¢…ëª© ì•Œë ¤ì¤˜"</small>
            </div>
        </div>

        <!-- ì…ë ¥ì°½ -->
        <div style="display: flex; gap: 0.5rem;">
            <input type="text" id="chatInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;" onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" class="success" style="padding: 0.75rem 2rem;">ì „ì†¡</button>
        </div>
    </div>
</div>

<!-- í¬íŠ¸í´ë¦¬ì˜¤ ìš”ì•½ -->
<div class="grid">
    <div class="stat-card">
        <h3>ì´ ìì‚°</h3>
        <div class="value">${{ "%.2f"|format(portfolio.total_value) }}</div>
    </div>
    <div class="stat-card">
        <h3>í˜„ê¸ˆ ì”ê³ </h3>
        <div class="value">${{ "%.2f"|format(portfolio.cash_balance) }}</div>
    </div>
    <div class="stat-card">
        <h3>ì¼ì¼ ì†ìµ</h3>
        <div class="value {% if portfolio.daily_pnl_pct >= 0 %}positive{% else %}negative{% endif %}">
            {{ "+" if portfolio.daily_pnl_pct >= 0 else "" }}{{ "%.2f"|format(portfolio.daily_pnl_pct) }}%
        </div>
        <small>${{ "%.2f"|format(portfolio.daily_pnl) }}</small>
    </div>
    <div class="stat-card">
        <h3>ì´ ì†ìµ</h3>
        <div class="value {% if portfolio.total_pnl_pct >= 0 %}positive{% else %}negative{% endif %}">
            {{ "+" if portfolio.total_pnl_pct >= 0 else "" }}{{ "%.2f"|format(portfolio.total_pnl_pct) }}%
        </div>
        <small>${{ "%.2f"|format(portfolio.total_pnl) }}</small>
    </div>
</div>

<!-- ë³´ìœ  í¬ì§€ì…˜ -->
<div class="card">
    <h2>ë³´ìœ  í¬ì§€ì…˜ ({{ portfolio.position_count }}ê°œ)</h2>
    {% if portfolio.positions %}
    <table>
        <thead>
            <tr>
                <th>ì¢…ëª©</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>í‰ë‹¨ê°€</th>
                <th>í˜„ì¬ê°€</th>
                <th>í‰ê°€ì•¡</th>
                <th>ì†ìµë¥ </th>
            </tr>
        </thead>
        <tbody>
            {% for pos in portfolio.positions %}
            <tr>
                <td><strong>{{ pos.ticker }}</strong></td>
                <td>{{ pos.quantity }}ì£¼</td>
                <td>${{ "%.2f"|format(pos.avg_cost) }}</td>
                <td>${{ "%.2f"|format(pos.current_price) }}</td>
                <td>${{ "%.2f"|format(pos.total_value) }}</td>
                <td class="{% if pos.unrealized_pnl_pct >= 0 %}positive{% else %}negative{% endif %}">
                    {{ "+" if pos.unrealized_pnl_pct >= 0 else "" }}{{ "%.2f"|format(pos.unrealized_pnl_pct) }}%
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #666;">ë³´ìœ  ì¤‘ì¸ í¬ì§€ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¶”ì²œ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', function() {
        refreshRecommendations();
        // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(refreshRecommendations, 5 * 60 * 1000);
    });

    // AI ì¶”ì²œ ìƒˆë¡œê³ ì¹¨
    async function refreshRecommendations() {
        const section = document.getElementById('recommendationsSection');
        section.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;"><p>ë¡œë”© ì¤‘...</p></div>';

        try {
            const response = await fetch('/api/recommendations/latest');
            if (!response.ok) throw new Error('ì¶”ì²œì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');

            const data = await response.json();
            displayRecommendations(data);
        } catch (error) {
            section.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 2rem;"><p>âŒ ì˜¤ë¥˜: ${error.message}</p></div>`;
        }
    }

    // ì¶”ì²œ í‘œì‹œ
    function displayRecommendations(data) {
        const section = document.getElementById('recommendationsSection');

        if (!data.recommendations || data.recommendations.length === 0) {
            section.innerHTML = `
                <div style="padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                    <p style="margin: 0; color: #856404;">${data.summary || 'ì•„ì§ ì¶”ì²œì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</p>
                    <small style="color: #856404;">ë‹¤ìŒ ì¶”ì²œì€ ì¥ ì‹œì‘, ì¥ ì¤‘ê°„, ì¥ ë§ˆê° ì‹œê°„ì— ìë™ ìƒì„±ë©ë‹ˆë‹¤.</small>
                </div>
            `;
            return;
        }

        // ì¶”ì²œ ìš”ì•½
        let html = `
            <div style="padding: 1rem; background: #d4edda; border: 1px solid #28a745; border-radius: 4px; margin-bottom: 1rem;">
                <p style="margin: 0; color: #155724; font-weight: 500;">ğŸ“Š ${data.market_phase || 'ì¼ë°˜'} ë¶„ì„</p>
                <p style="margin: 0.5rem 0 0 0; color: #155724;">${data.summary || ''}</p>
                <small style="color: #155724;">ìƒì„± ì‹œê°: ${new Date(data.timestamp).toLocaleString('ko-KR')}</small>
            </div>
        `;

        // ì¶”ì²œ ëª©ë¡
        html += '<div style="display: flex; flex-direction: column; gap: 1rem;">';

        data.recommendations.forEach((rec, idx) => {
            const actionColor = rec.action === 'BUY' ? '#28a745' : rec.action === 'SELL' ? '#dc3545' : '#6c757d';
            const actionEmoji = rec.action === 'BUY' ? 'ğŸ“ˆ' : rec.action === 'SELL' ? 'ğŸ“‰' : 'â¸ï¸';

            html += `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                        <div>
                            <h3 style="margin: 0; font-size: 1.25rem; color: ${actionColor};">
                                ${actionEmoji} ${rec.action} ${rec.ticker}
                            </h3>
                            <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.9rem;">
                                ${rec.rationale || ''}
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.1rem; font-weight: bold; color: ${actionColor};">
                                ${rec.percentage}%
                            </div>
                            <small style="color: #666;">ì‹ ë¢°ë„: ${rec.confidence}%</small>
                        </div>
                    </div>
                    ${rec.action !== 'HOLD' ? `
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                        <button onclick="executeRecommendation('${rec.ticker}', '${rec.action}', ${rec.percentage})"
                                class="success" style="flex: 1; padding: 0.5rem;">
                            âœ… ìŠ¹ì¸ ë° ì‹¤í–‰
                        </button>
                        <button onclick="alert('ì¶”ì²œì´ ë¬´ì‹œë˜ì—ˆìŠµë‹ˆë‹¤')"
                                class="danger" style="flex: 1; padding: 0.5rem;">
                            âŒ ë¬´ì‹œ
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
        });

        html += '</div>';
        section.innerHTML = html;
    }

    // ì¶”ì²œ ì‹¤í–‰
    async function executeRecommendation(ticker, action, percentage) {
        if (!confirm(`${action} ${ticker} (${percentage}%)ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        try {
            const response = await fetch('/api/recommendations/execute', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    ticker: ticker,
                    action: action,
                    percentage: percentage
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'ì‹¤í–‰ ì‹¤íŒ¨');
            }

            const result = await response.json();

            if (result.success) {
                alert(`âœ… ${result.message}`);
                // í¬íŠ¸í´ë¦¬ì˜¤ ìƒˆë¡œê³ ì¹¨
                location.reload();
            } else {
                alert(`âŒ ì‹¤íŒ¨: ${result.message}`);
            }
        } catch (error) {
            alert(`âŒ ì˜¤ë¥˜: ${error.message}`);
        }
    }

    // ì±—ë´‡ ë©”ì‹œì§€ ì „ì†¡
    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const messagesDiv = document.getElementById('chatMessages');
        const message = input.value.trim();

        if (!message) return;

        // ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ ì œê±°
        if (messagesDiv.children.length === 1 && messagesDiv.children[0].style.textAlign === 'center') {
            messagesDiv.innerHTML = '';
        }

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        addMessage('user', message);
        input.value = '';

        // ë¡œë”© í‘œì‹œ
        const loadingId = 'loading-' + Date.now();
        addMessage('assistant', 'ë¶„ì„ ì¤‘...', loadingId);

        try {
            // API í˜¸ì¶œ
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: message})
            });

            // ì‘ë‹µ ìƒíƒœ í™•ì¸
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status}): ${errorText}`);
            }

            const data = await response.json();

            // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            const loadingMsg = document.getElementById(loadingId);
            if (loadingMsg) loadingMsg.remove();

            // AI ì‘ë‹µ ì¶”ê°€
            if (data.response) {
                addMessage('assistant', data.response);
            } else {
                addMessage('assistant', 'âŒ ì˜¤ë¥˜: ' + (data.error || 'ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'));
            }
        } catch (error) {
            // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            const loadingMsg = document.getElementById(loadingId);
            if (loadingMsg) loadingMsg.remove();

            addMessage('assistant', 'âŒ ì˜¤ë¥˜: ' + error.message);
        }

        // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addMessage(role, content, id = null) {
        const messagesDiv = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        if (id) messageDiv.id = id;

        messageDiv.style.cssText = `
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            ${role === 'user'
                ? 'background: #007bff; color: white; margin-left: 20%; text-align: right;'
                : 'background: white; border: 1px solid #ddd; margin-right: 20%;'
            }
        `;

        messageDiv.innerHTML = `
            <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.25rem;">
                ${role === 'user' ? 'ğŸ‘¤ ë‚˜' : 'ğŸ¤– AI ë¶„ì„'}
            </div>
            <div style="white-space: pre-wrap; line-height: 1.5;">${content}</div>
        `;

        messagesDiv.appendChild(messageDiv);
    }

    // ì—”í„° í‚¤ë¡œ ì „ì†¡
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>
{% endblock %}
