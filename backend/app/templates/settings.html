{% extends "base.html" %}

{% block title %}ì„¤ì • - US Stock Trading Bot{% endblock %}

{% block content %}
<h1>ì„¤ì •</h1>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if success %}
<div class="alert alert-success">{{ success }}</div>
{% endif %}

<!-- API í‚¤ ì„¤ì • -->
<div class="card">
    <h2>ğŸ”‘ API í‚¤ ê´€ë¦¬</h2>

    <form method="post" action="/settings/save-keys" style="margin-bottom: 2rem;">
        <h3 style="margin-top: 0; font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">í•œêµ­íˆ¬ìì¦ê¶Œ API</h3>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">App Key</label>
            <input type="text" name="app_key" value="{{ api_keys.get('app_key', '') }}" placeholder="í•œêµ­íˆ¬ìì¦ê¶Œ App Key ì…ë ¥" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">App Secret</label>
            <input type="password" name="app_secret" value="{{ api_keys.get('app_secret', '') }}" placeholder="í•œêµ­íˆ¬ìì¦ê¶Œ App Secret ì…ë ¥" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ê³„ì¢Œë²ˆí˜¸</label>
            <input type="text" name="account_number" value="{{ api_keys.get('account_number', '') }}" placeholder="ê³„ì¢Œë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: 12345678-01)" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
            <small style="color: #666; display: block; margin-top: 0.25rem;">í˜•ì‹: 12345678-01</small>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ê³„ì¢Œ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" name="account_password" value="{{ api_keys.get('account_password', '') }}" placeholder="ê³„ì¢Œ ë¹„ë°€ë²ˆí˜¸ (í•´ì™¸ì£¼ì‹ ê±°ë˜ìš©)" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
            <small style="color: #666; display: block; margin-top: 0.25rem;">âš ï¸ í•´ì™¸ì£¼ì‹ ê±°ë˜ ì‹œ í•„ìˆ˜ (4ìë¦¬ ìˆ«ì)</small>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="password_padding" value="true" {% if password_padding %}checked{% endif %} style="margin-right: 0.5rem;">
                <span>ë¹„ë°€ë²ˆí˜¸ 8ìë¦¬ íŒ¨ë”© ì‚¬ìš© (4ìë¦¬ â†’ 8ìë¦¬ ê³µë°± íŒ¨ë”©)</span>
            </label>
            <small style="color: #666; display: block; margin-top: 0.25rem; margin-left: 1.75rem;">ì¼ë¶€ APIì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ 8ìë¦¬ë¡œ ìš”êµ¬í•˜ëŠ” ê²½ìš° ì²´í¬</small>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="paper_mode" value="true" {% if paper_mode %}checked{% endif %} style="margin-right: 0.5rem;">
                <span>ëª¨ì˜ íˆ¬ì ëª¨ë“œ (Paper Trading)</span>
            </label>
        </div>

        <h3 style="font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-top: 2rem;">Google Gemini API</h3>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Gemini API Key</label>
            <input type="password" name="gemini_api_key" value="{{ api_keys.get('gemini_api_key', '') }}" placeholder="Google Gemini API Key ì…ë ¥" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
            <small style="color: #666; display: block; margin-top: 0.25rem;">AI ê±°ë˜ ê²°ì •ì— ì‚¬ìš©ë©ë‹ˆë‹¤</small>
        </div>

        <h3 style="font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-top: 2rem;">WallStreetBets ë°ì´í„° ì†ŒìŠ¤</h3>

        <div style="padding: 1rem; background: #d4edda; border: 1px solid #28a745; border-radius: 4px; margin-bottom: 1rem;">
            <p style="margin: 0; color: #155724; font-weight: 500;">âœ… API í‚¤ ë¶ˆí•„ìš” - ìë™ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!</p>
            <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem; color: #155724; font-size: 0.9rem;">
                <li><strong>ì£¼ìš” ë°©ë²•:</strong> Reddit RSS í”¼ë“œ (ì¸ì¦ ë¶ˆí•„ìš”)</li>
                <li><strong>ëŒ€ì•ˆ ë°©ë²•:</strong> Finnhub ì†Œì…œ ì„¼í‹°ë¨¼íŠ¸ (RSS ì‹¤íŒ¨ ì‹œ ìë™ ì „í™˜)</li>
                <li>ë³„ë„ ì„¤ì • ì—†ì´ WallStreetBets íŠ¸ë Œë”© ì¢…ëª© ì •ë³´ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤</li>
            </ul>
        </div>

        <h3 style="font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-top: 2rem;">AI ë§¤ë§¤ ì¶”ì²œ ì„¤ì •</h3>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="auto_trading_enabled" value="true" {% if auto_trading_enabled %}checked{% endif %} style="margin-right: 0.5rem;">
                <span><strong>ìë™ ê±°ë˜ ëª¨ë“œ</strong> (AI ì¶”ì²œì„ ì‚¬ìš©ì ìŠ¹ì¸ ì—†ì´ ìë™ ì‹¤í–‰)</span>
            </label>
            <small style="color: #666; display: block; margin-top: 0.25rem; margin-left: 1.75rem;">
                âš ï¸ ë¹„í™œì„±í™” ì‹œ: ëŒ€ì‹œë³´ë“œì—ì„œ ìŠ¹ì¸ í›„ ì‹¤í–‰ (ë°˜ìë™)<br>
                âš ï¸ í™œì„±í™” ì‹œ: AI ì¶”ì²œì„ ìë™ìœ¼ë¡œ ì‹¤í–‰ (ìë™) - ì£¼ì˜ í•„ìš”!
            </small>
        </div>

        <button type="submit" class="success">ì €ì¥</button>
    </form>

    {% if api_keys %}
    <div style="padding: 1rem; background: #f8f9fa; border-radius: 4px; margin-top: 1rem;">
        <h3 style="margin-top: 0; font-size: 0.95rem; color: #666;">í˜„ì¬ ì„¤ì •ëœ API í‚¤</h3>
        <ul style="margin: 0; padding-left: 1.5rem;">
            {% if api_keys.get('app_key') %}
            <li><strong>í•œíˆ¬ App Key:</strong> {{ api_keys.get('app_key')[:8] }}... âœ“</li>
            {% endif %}
            {% if api_keys.get('app_secret') %}
            <li><strong>í•œíˆ¬ App Secret:</strong> ********** âœ“</li>
            {% endif %}
            {% if api_keys.get('account_number') %}
            <li><strong>ê³„ì¢Œë²ˆí˜¸:</strong> {{ api_keys.get('account_number') }} âœ“</li>
            {% endif %}
            {% if api_keys.get('account_password') %}
            <li><strong>ê³„ì¢Œ ë¹„ë°€ë²ˆí˜¸:</strong> **** âœ“</li>
            {% endif %}
            {% if api_keys.get('gemini_api_key') %}
            <li><strong>Gemini API Key:</strong> {{ api_keys.get('gemini_api_key')[:8] }}... âœ“</li>
            {% endif %}
            {% if api_keys.get('reddit_client_id') %}
            <li><strong>Reddit Client ID:</strong> {{ api_keys.get('reddit_client_id')[:8] }}... âœ“</li>
            {% endif %}
            {% if api_keys.get('reddit_client_secret') %}
            <li><strong>Reddit Client Secret:</strong> ********** âœ“</li>
            {% endif %}
            {% if api_keys.get('reddit_user_agent') %}
            <li><strong>Reddit User Agent:</strong> {{ api_keys.get('reddit_user_agent') }} âœ“</li>
            {% endif %}
        </ul>
    </div>
    {% else %}
    <div style="padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin-top: 1rem;">
        <p style="margin: 0; color: #856404;">âš ï¸ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê±°ë˜ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ìœ„ ì–‘ì‹ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.</p>
    </div>
    {% endif %}
</div>

<!-- ë¦¬ìŠ¤í¬ íŒŒë¼ë¯¸í„° -->
<div class="card">
    <h2>âš™ï¸ ë¦¬ìŠ¤í¬ íŒŒë¼ë¯¸í„°</h2>

    <form method="post" action="/settings/save-risk-params">
        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ì´ˆê¸° ìë³¸ (USD)</label>
            <input type="number" name="initial_capital_usd" value="{{ risk_params.initial_capital_usd }}" min="1" max="1000000" step="0.01" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
            <small style="color: #666; display: block; margin-top: 0.25rem;">ì†ìµë¥  ê³„ì‚° ê¸°ì¤€ì´ ë˜ëŠ” ì´ˆê¸° ìë³¸ (ë‹¬ëŸ¬ ê¸°ì¤€)</small>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ìµœëŒ€ í¬ì§€ì…˜ ìˆ˜</label>
            <input type="number" name="max_positions" value="{{ risk_params.max_positions }}" min="1" max="20" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
            <small style="color: #666; display: block; margin-top: 0.25rem;">ë™ì‹œì— ë³´ìœ í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ ì¢…ëª© ìˆ˜</small>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">í¬ì§€ì…˜ë‹¹ ìµœëŒ€ ë¹„ì¤‘ (%)</label>
            <input type="number" name="max_position_size_pct" value="{{ risk_params.max_position_size_pct }}" min="1" max="100" step="0.1" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
            <small style="color: #666; display: block; margin-top: 0.25rem;">ì „ì²´ ìì‚° ëŒ€ë¹„ í•œ ì¢…ëª©ì˜ ìµœëŒ€ ë¹„ì¤‘</small>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ì†ì ˆ ê¸°ì¤€ (%)</label>
            <input type="number" name="stop_loss_pct" value="{{ risk_params.stop_loss_pct }}" min="1" max="50" step="0.1" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
            <small style="color: #666; display: block; margin-top: 0.25rem;">ë§¤ìˆ˜ê°€ ëŒ€ë¹„ ì†ì‹¤ ì‹œ ìë™ ë§¤ë„ ê¸°ì¤€</small>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ìµì ˆ ê¸°ì¤€ (%)</label>
            <input type="number" name="take_profit_pct" value="{{ risk_params.take_profit_pct }}" min="1" max="200" step="0.1" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
            <small style="color: #666; display: block; margin-top: 0.25rem;">ë§¤ìˆ˜ê°€ ëŒ€ë¹„ ì´ìµ ì‹œ ìë™ ë§¤ë„ ê¸°ì¤€</small>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ì¼ì¼ ìµœëŒ€ ì†ì‹¤ë¥  (ì„œí‚·ë¸Œë ˆì´ì»¤) (%)</label>
            <input type="number" name="daily_loss_limit_pct" value="{{ risk_params.daily_loss_limit_pct }}" min="1" max="50" step="0.1" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
            <small style="color: #666; display: block; margin-top: 0.25rem;">ì¼ì¼ ì†ì‹¤ì´ ì´ ë¹„ìœ¨ ì´ˆê³¼ ì‹œ ëª¨ë“  ê±°ë˜ ì¤‘ë‹¨</small>
        </div>

        <button type="submit" class="success">ì €ì¥</button>
    </form>
</div>

<!-- íˆ¬ì ì„ í˜¸ë„ (ì±—ë´‡ì—ì„œ ìë™ ìˆ˜ì§‘) -->
<div class="card">
    <h2>ğŸ¯ íˆ¬ì ì„ í˜¸ë„</h2>
    <p style="color: #666; margin-bottom: 1.5rem;">
        ğŸ’¬ ì±—ë´‡ê³¼ ëŒ€í™”í•˜ë©´ ìë™ìœ¼ë¡œ íˆ¬ì ì„ í˜¸ë„ê°€ ì €ì¥ë©ë‹ˆë‹¤.<br>
        ì˜ˆ: "ê¸°ìˆ ì£¼ ì¢‹ì•„í•´", "AAPL ê´€ì‹¬ìˆì–´", "ë³´ìˆ˜ì ìœ¼ë¡œ íˆ¬ìí•˜ê³  ì‹¶ì–´"
    </p>

    <div id="investmentPreferences">
        <p style="text-align: center; color: #666;">ë¡œë”© ì¤‘...</p>
    </div>
</div>

<!-- ì‹œìŠ¤í…œ ì •ë³´ -->
<div class="card">
    <h2>â„¹ï¸ ì‹œìŠ¤í…œ ì •ë³´</h2>
    <table>
        <tbody>
            <tr>
                <td><strong>ë²„ì „</strong></td>
                <td>1.0.0</td>
            </tr>
            <tr>
                <td><strong>ë°ì´í„°ë² ì´ìŠ¤</strong></td>
                <td>SQLite</td>
            </tr>
            <tr>
                <td><strong>ë¸Œë¡œì»¤</strong></td>
                <td>í•œêµ­íˆ¬ìì¦ê¶Œ</td>
            </tr>
            <tr>
                <td><strong>ìš´ì˜ ëª¨ë“œ</strong></td>
                <td>{% if paper_mode %}ëª¨ì˜ íˆ¬ì{% else %}ì‹¤ì „ íˆ¬ì{% endif %}</td>
            </tr>
        </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
<script>
    // í¼ ì œì¶œ ì‹œ í™•ì¸
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', (e) => {
            const btn = form.querySelector('button[type="submit"]');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'ì €ì¥ ì¤‘...';
            }
        });
    });

    // Load investment preferences
    async function loadPreferences() {
        try {
            const response = await fetch('/api/preferences/investment');
            const data = await response.json();

            const container = document.getElementById('investmentPreferences');

            if (!data.exists) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 4px;">
                        <p style="color: #666; margin: 0;">${data.message || 'ì•„ì§ íˆ¬ì ì„ í˜¸ë„ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</p>
                    </div>
                `;
                return;
            }

            const prefs = data.preferences;

            const riskMap = {
                'conservative': 'ë³´ìˆ˜ì  (ì•ˆì „í•œ íˆ¬ì ì„ í˜¸)',
                'moderate': 'ì¤‘ë¦½ì  (ê· í˜• ì¡íŒ íˆ¬ì)',
                'aggressive': 'ê³µê²©ì  (ê³ ìœ„í—˜ ê³ ìˆ˜ìµ ì¶”êµ¬)'
            };

            const styleMap = {
                'growth': 'ì„±ì¥ì£¼ ì„ í˜¸',
                'value': 'ê°€ì¹˜ì£¼ ì„ í˜¸',
                'dividend': 'ë°°ë‹¹ì£¼ ì„ í˜¸',
                'balanced': 'ê· í˜• ì¡íŒ í¬íŠ¸í´ë¦¬ì˜¤'
            };

            let html = '<table><tbody>';

            html += `<tr><td><strong>ìœ„í—˜ ì„±í–¥</strong></td><td>${riskMap[prefs.risk_appetite] || prefs.risk_appetite}</td></tr>`;
            html += `<tr><td><strong>íˆ¬ì ìŠ¤íƒ€ì¼</strong></td><td>${styleMap[prefs.investment_style] || prefs.investment_style}</td></tr>`;

            if (prefs.preferred_sectors && prefs.preferred_sectors.length > 0) {
                html += `<tr><td><strong>ì„ í˜¸ ì„¹í„°</strong></td><td>${prefs.preferred_sectors.join(', ')}</td></tr>`;
            }

            if (prefs.avoided_sectors && prefs.avoided_sectors.length > 0) {
                html += `<tr><td><strong>íšŒí”¼ ì„¹í„°</strong></td><td>${prefs.avoided_sectors.join(', ')}</td></tr>`;
            }

            if (prefs.preferred_tickers && prefs.preferred_tickers.length > 0) {
                html += `<tr><td><strong>ì„ í˜¸ ì¢…ëª©</strong></td><td>${prefs.preferred_tickers.join(', ')}</td></tr>`;
            }

            if (prefs.avoided_tickers && prefs.avoided_tickers.length > 0) {
                html += `<tr><td><strong>íšŒí”¼ ì¢…ëª©</strong></td><td>${prefs.avoided_tickers.join(', ')}</td></tr>`;
            }

            const strategies = [];
            if (prefs.prefer_diversification) strategies.push('ë¶„ì‚° íˆ¬ì');
            if (prefs.prefer_dip_buying) strategies.push('ì €ì  ë§¤ìˆ˜');
            if (prefs.prefer_momentum) strategies.push('ëª¨ë©˜í…€ íˆ¬ì');

            if (strategies.length > 0) {
                html += `<tr><td><strong>íˆ¬ì ì „ëµ</strong></td><td>${strategies.join(', ')}</td></tr>`;
            }

            if (prefs.last_updated) {
                const date = new Date(prefs.last_updated);
                html += `<tr><td><strong>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</strong></td><td>${date.toLocaleString('ko-KR')}</td></tr>`;
            }

            html += '</tbody></table>';

            if (prefs.custom_instructions) {
                html += `
                    <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                        <strong>ì¶”ê°€ ì§€ì¹¨:</strong><br>
                        <pre style="white-space: pre-wrap; margin: 0.5rem 0 0 0; font-family: inherit; font-size: 0.9rem;">${prefs.custom_instructions}</pre>
                    </div>
                `;
            }

            container.innerHTML = html;

        } catch (error) {
            console.error('Failed to load preferences:', error);
            document.getElementById('investmentPreferences').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #dc3545;">
                    <p>ì„ í˜¸ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                </div>
            `;
        }
    }

    // Load on page load
    loadPreferences();
</script>
{% endblock %}
